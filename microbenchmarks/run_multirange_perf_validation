#!/bin/bash

RESULTDIR=$1
IOMETHOD=$2

PORT_MASTER=6001
PORT_PATCHED=6002

DBNAME="test"
SCRIPT="multirange"

# expected to run from the script directory
DIR=$(pwd)

if pg_isready -p $PORT_MASTER; then
  dropdb -p $PORT_MASTER --if-exists $DBNAME
  createdb -p $PORT_MASTER $DBNAME
  psql $DBNAME -p $PORT_MASTER -f "$DIR/validate/${SCRIPT}.sql" > "$RESULTDIR/output_patch_$SCRIPT.txt"
fi

if pg_isready -p $PORT_PATCHED; then
  dropdb -p $PORT_PATCHED --if-exists $DBNAME
  createdb -p $PORT_PATCHED $DBNAME
  psql $DBNAME -p $PORT_PATCHED -f "$DIR/validate/${SCRIPT}.sql" > "$RESULTDIR/output_master_$SCRIPT.txt"
fi

index_pattern="test_multirange_idx|test_multirange_allhighcardinality_idx|test_multirange_medcard_idx"
grep -E "$index_pattern"  -A 9 "$RESULTDIR/output_patch_$SCRIPT.txt" | grep -E "Execution|Index [O]|Index Searches" > "/tmp/diff_results_patch_$SCRIPT.txt"
grep -E "$index_pattern"  -A 9 "$RESULTDIR/output_master_$SCRIPT.txt" | grep -E "Execution|Index [O]" > "/tmp/diff_results_master_$SCRIPT.txt"

# Extract execution times from both files
patch_times=$(grep -oP 'Execution Time: \K[0-9\.]+(?= ms)' "/tmp/diff_results_patch_$SCRIPT.txt")
master_times=$(grep -oP 'Execution Time: \K[0-9\.]+(?= ms)' "/tmp/diff_results_master_$SCRIPT.txt")
patch_indexes=$(grep -oP 'Index Only Scan(?: Backward)? using \K[^ ]+(?= on)' "/tmp/diff_results_patch_$SCRIPT.txt")
patch_nsearches=$(grep -oP 'Index Searches: \K[0-9]+' "/tmp/diff_results_patch_$SCRIPT.txt")

# Convert to arrays for processing
patch_array=($patch_times)
master_array=($master_times)
index_array=($patch_indexes)
index_searches=($patch_nsearches)
readarray -t query_array < <(grep -E ".*from test.*:$" "$RESULTDIR/output_patch_$SCRIPT.txt")

# Ensure the files have the same number of execution times
if [ "${#patch_array[@]}" -ne "${#master_array[@]}" ]; then
  echo "Error: Mismatch in the number of execution times between files."
  exit 1
fi

if [ "${#patch_array[@]}" -ne "${#index_array[@]}" ]; then
  echo "Error: Mismatch in the number of index names ${#index_array[@]} and patch result times ${#patch_array[@]}."
  exit 1
fi

rm "$RESULTDIR/ratio_$SCRIPT.txt"
printf "\nResults with ratios for most recent \"$SCRIPT\" run:\n\n" >> "$RESULTDIR/ratio_$SCRIPT.txt"

# Calculate and print the ratio of execution times
for i in "${!patch_array[@]}"; do
  patch_time="${patch_array[$i]}"
  master_time="${master_array[$i]}"
  index_name="${index_array[$i]}"
  index_searches="${index_searches[$i]}"
  query="${query_array[$i]}"

  # Avoid division by zero
  if (( $(echo "$master_time == 0" | bc -l) )); then
    echo "Error: Division by zero encountered in master file at line $((i + 1))." >> "$RESULTDIR/ratio_$SCRIPT.txt"
    continue
  fi

  ratio=$(echo "scale=4; $patch_time / $master_time" | bc)
  echo "Result $((i + 1)), $query" >> "$RESULTDIR/ratio_$SCRIPT.txt"
  echo "  Result $((i + 1)), index = $index_name, nsearches = $index_searches, patch = $patch_time ms, master = $master_time ms, ratio = $ratio" >> "$RESULTDIR/ratio_$SCRIPT.txt"
  echo "" >> "$RESULTDIR/ratio_$SCRIPT.txt"

  echo $IOMETHOD $SCRIPT $((i+1)) $index_name $index_searches $master_time $patch_time $ratio >> $RESULTDIR/ratio_$SCRIPT.csv
done
cat "$RESULTDIR/ratio_$SCRIPT.txt"
