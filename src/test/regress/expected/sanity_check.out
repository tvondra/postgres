VACUUM;
--
-- sanity check, if we don't have indices the test will take years to
-- complete.  But skip TOAST relations (since they will have varying
-- names depending on the current OID counter) as well as temp tables
-- of other backends (to avoid timing-dependent behavior).
--
-- temporarily disable fancy output, so catalog changes create less diff noise
\a\t
SELECT relname, relhasindex, relhascstore
   FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = relnamespace
   WHERE relkind = 'r' AND (nspname ~ '^pg_temp_') IS NOT TRUE
   ORDER BY relname;
a|f|f
a_star|f|f
abstime_tbl|f|f
aggtest|f|f
array_index_op_test|t|f
array_op_test|f|f
b|f|f
b_star|f|f
box_tbl|f|f
bprime|f|f
bt_f8_heap|t|f
bt_i4_heap|t|f
bt_name_heap|t|f
bt_txt_heap|t|f
c|f|f
c_star|f|f
char_tbl|f|f
check2_tbl|f|f
check_tbl|f|f
circle_tbl|t|f
city|f|f
copy_tbl|f|f
d|f|f
d_star|f|f
date_tbl|f|f
default_tbl|f|f
defaultexpr_tbl|f|f
dept|f|f
dupindexcols|t|f
e_star|f|f
emp|f|f
equipment_r|f|f
f_star|f|f
fast_emp4000|t|f
float4_tbl|f|f
float8_tbl|f|f
func_index_heap|t|f
hash_f8_heap|t|f
hash_i4_heap|t|f
hash_name_heap|t|f
hash_txt_heap|t|f
hobbies_r|f|f
ihighway|t|f
inet_tbl|f|f
inhf|f|f
inhx|t|f
insert_tbl|f|f
int2_tbl|f|f
int4_tbl|f|f
int8_tbl|f|f
interval_tbl|f|f
iportaltest|f|f
kd_point_tbl|t|f
line_tbl|f|f
log_table|f|f
lseg_tbl|f|f
main_table|f|f
money_data|f|f
num_data|f|f
num_exp_add|t|f
num_exp_div|t|f
num_exp_ln|t|f
num_exp_log10|t|f
num_exp_mul|t|f
num_exp_power_10_ln|t|f
num_exp_sqrt|t|f
num_exp_sub|t|f
num_input_test|f|f
num_result|f|f
onek|t|f
onek2|t|f
path_tbl|f|f
person|f|f
pg_aggregate|t|f
pg_am|t|f
pg_amop|t|f
pg_amproc|t|f
pg_attrdef|t|f
pg_attribute|t|f
pg_auth_members|t|f
pg_authid|t|f
pg_cast|t|f
pg_class|t|f
pg_collation|t|f
pg_constraint|t|f
pg_conversion|t|f
pg_cstore|t|f
pg_cstore_am|t|f
pg_database|t|f
pg_db_role_setting|t|f
pg_default_acl|t|f
pg_depend|t|f
pg_description|t|f
pg_enum|t|f
pg_event_trigger|t|f
pg_extension|t|f
pg_foreign_data_wrapper|t|f
pg_foreign_server|t|f
pg_foreign_table|t|f
pg_index|t|f
pg_inherits|t|f
pg_language|t|f
pg_largeobject|t|f
pg_largeobject_metadata|t|f
pg_namespace|t|f
pg_opclass|t|f
pg_operator|t|f
pg_opfamily|t|f
pg_pltemplate|t|f
pg_policy|t|f
pg_proc|t|f
pg_range|t|f
pg_replication_origin|t|f
pg_rewrite|t|f
pg_seclabel|t|f
pg_shdepend|t|f
pg_shdescription|t|f
pg_shseclabel|t|f
pg_statistic|t|f
pg_tablespace|t|f
pg_transform|t|f
pg_trigger|t|f
pg_ts_config|t|f
pg_ts_config_map|t|f
pg_ts_dict|t|f
pg_ts_parser|t|f
pg_ts_template|t|f
pg_type|t|f
pg_user_mapping|t|f
point_tbl|t|f
polygon_tbl|t|f
quad_point_tbl|t|f
radix_text_tbl|t|f
ramp|f|f
real_city|f|f
reltime_tbl|f|f
road|t|f
shighway|t|f
slow_emp4000|f|f
sql_features|f|f
sql_implementation_info|f|f
sql_languages|f|f
sql_packages|f|f
sql_parts|f|f
sql_sizing|f|f
sql_sizing_profiles|f|f
stud_emp|f|f
student|f|f
tenk1|t|f
tenk2|t|f
test_range_excl|t|f
test_range_gist|t|f
test_range_spgist|t|f
test_tsvector|f|f
testjsonb|f|f
text_tbl|f|f
time_tbl|f|f
timestamp_tbl|f|f
timestamptz_tbl|f|f
timetz_tbl|f|f
tinterval_tbl|f|f
varchar_tbl|f|f
-- restore normal output mode
\a\t
--
-- another sanity check: every system catalog that has OIDs should have
-- a unique index on OID.  This ensures that the OIDs will be unique,
-- even after the OID counter wraps around.
-- We exclude non-system tables from the check by looking at nspname.
--
SELECT relname, nspname
FROM pg_class c LEFT JOIN pg_namespace n ON n.oid = relnamespace
WHERE relhasoids
    AND ((nspname ~ '^pg_') IS NOT FALSE)
    AND NOT EXISTS (SELECT 1 FROM pg_index i WHERE indrelid = c.oid
                    AND indkey[0] = -2 AND indnatts = 1
                    AND indisunique AND indimmediate);
 relname | nspname 
---------+---------
(0 rows)

